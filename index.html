<!doctype html>
<html lang="en">
<head>
  <!-- PM (Spelling only) — Auto Mark | Designed by Lim Kim Sze © 2026 -->
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Progress Monitoring — I Can Spell (Auto Mark)</title>

  <!-- Favicon (Kim Sze standard) -->
  <link rel="icon" href="./kimsze_sharp16.ico?v=20260111a" sizes="any">
  <link rel="shortcut icon" href="./kimsze_sharp16.ico?v=20260111a">

  <!-- ✅ Always-Clear on Load (Default Build Contract) -->
  <script>
  (function(){
    const ACTIVITY_ID = (window.ACTIVITY_ID || (location.origin + location.pathname));
    try{
      const del = [];
      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if(!k) continue;
        if(k === ACTIVITY_ID) del.push(k);
        if(k.startsWith(ACTIVITY_ID+"::")) del.push(k);
        if(k.startsWith("sls_scope::"+ACTIVITY_ID)) del.push(k);
        if(k.startsWith("UFCO-firstSubmit::"+ACTIVITY_ID)) del.push(k);
        if(k.startsWith("sls_unlike_payload::"+ACTIVITY_ID)) del.push(k);
      }
      del.forEach(k=>localStorage.removeItem(k));
      sessionStorage.removeItem("UFCO-firstSubmit::"+ACTIVITY_ID);
      sessionStorage.removeItem("sls_scope::"+ACTIVITY_ID);
      try{
        const bc = new BroadcastChannel("xapi-state");
        bc.postMessage({type:"clear", activityId: ACTIVITY_ID, ts: Date.now()});
        bc.close();
      }catch(e){}
    }catch(e){}
  })();
  </script>

  <!-- Counter.dev (Kim Sze standard) -->
  <script async src="https://cdn.counter.dev/script.js"
          data-id="REPLACE_WITH_YOUR_COUNTERDEV_ID"
          data-utcoffset="8"></script>

  <style>
    :root{
      --ink:#0b1220;
      --muted:#334155;
      --paper:#ffffff;

      --line:#0b0f17;
      --grey:#cfcfcf;

      --ok:#16a34a;
      --bad:#dc2626;

      --shadow: 0 18px 52px rgba(2, 6, 23, .12);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    html,body{height:100%;}
    body{
      margin:0;
      font-family:var(--font);
      background:#f3f4f6;
      color:var(--ink);
      overflow:auto;
      -webkit-tap-highlight-color: transparent;
    }

    .wrap{
      min-height:100%;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:14px;
      box-sizing:border-box;
    }

    .card{
      width:min(980px, calc(100vw - 20px));
      background:var(--paper);
      border:5px solid var(--line);
      border-radius:14px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .hdr{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 16px 10px;
      border-bottom:5px solid var(--line);
      flex-wrap:wrap;
    }
    .hdrLeft{
      display:flex; align-items:center; gap:12px; flex-wrap:wrap;
    }
    .hdr h1{
      margin:0;
      font-size:32px;
      font-weight:1000;
      text-decoration: underline;
      text-underline-offset: 6px;
    }
    .pencil{
      width:44px; height:44px;
      border-radius:10px;
      background:#e5e7eb;
      display:grid;
      place-items:center;
      font-weight:1000;
      color:#111827;
      user-select:none;
    }

    .nameBox{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:1000;
      font-size:16px;
      flex-wrap:wrap;
    }
    .nameInput{
      width:min(320px, 70vw);
      border:3px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      font-size:16px;
      outline:none;
    }

    .sub{
      padding:10px 16px 12px 16px;
      color:var(--muted);
      font-weight:800;
      font-size:14px;
      line-height:1.35;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    .sessionCtl{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .sel{
      border:3px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      font-weight:1000;
      background:#fff;
      outline:none;
    }
    .tag{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      border:2px solid #0b0f17;
      background:#fff;
      color:#0b1220;
      font-weight:1000;
      font-size:12px;
      white-space:nowrap;
    }

    .tryHead{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      border-top:5px solid var(--line);
      border-bottom:5px solid var(--line);
      background:var(--grey);
    }
    .tryHead div{
      padding:10px 12px;
      font-weight:1000;
      font-size:22px;
      border-left:5px solid var(--line);
    }
    .tryHead div:first-child{border-left:0;}

    .dateRow{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      border-bottom:5px solid var(--line);
      background:#fff;
    }
    .dateCell{
      padding:10px 12px;
      border-left:5px solid var(--line);
      font-weight:1000;
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .dateCell:first-child{border-left:0;}
    .dateLabel{white-space:nowrap;}
    .dateVal{
      flex:1;
      border-bottom:3px solid var(--line);
      padding:4px 6px;
      min-height:24px;
      font-weight:1000;
      color:#0b1220;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .lockedTag{
      display:inline-block;
      margin-left:8px;
      font-size:12px;
      font-weight:1000;
      padding:4px 8px;
      border-radius:999px;
      border:2px solid #64748b;
      color:#64748b;
      background:#f8fafc;
      white-space:nowrap;
    }

    .tries{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      min-height: 340px;
    }
    .tryCol{
      border-left:5px solid var(--line);
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .tryCol:first-child{border-left:0;}

    .blankArea{
      flex:1 1 auto;
      padding:18px 18px 10px;
      display:flex;
      flex-direction:column;
      gap:22px;
      min-height: 260px;
    }

    .line{
      display:grid;
      grid-template-columns: 40px 1fr 46px;
      gap:10px;
      align-items:end;
      min-width:0;
    }
    .idx{
      font-size:22px;
      font-weight:1000;
      text-align:right;
      padding-bottom:6px;
      user-select:none;
    }

    .ansWrap{min-width:0; position:relative;}
    .ans{
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      font-size:22px;
      font-weight:900;
      letter-spacing:1px;
      text-transform:lowercase;
      padding:2px 6px 10px 6px;
      border-bottom:4px solid var(--line);
      box-sizing:border-box;
    }
    .ans:disabled{opacity:.55;}

    .hear{
      width:46px; height:46px;
      border-radius:14px;
      border:3px solid var(--line);
      background:#fff;
      cursor:pointer;
      font-size:18px;
      display:grid;
      place-items:center;
      font-weight:1000;
      user-select:none;
      flex:0 0 auto;
    }
    .hear:active{transform:translateY(1px);}
    .hear:disabled{opacity:.45; cursor:not-allowed;}

    .mk{
      margin-top:8px;
      min-height:28px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      font-weight:1000;
      font-size:18px;
    }
    .tick{color:var(--ok);}
    .cross{color:var(--bad);}

    .correctSp{
      font-size:14px;
      font-weight:1000;
      color:#0b1220;
      margin-top:4px;
    }
    .correctSp .label{color:#475569; font-weight:1000;}

    .circWord{
      display:inline-flex;
      gap:2px;
      font-size:22px;
      letter-spacing:1px;
      text-transform:lowercase;
      align-items:center;
      flex-wrap:wrap;
    }
    .ch{
      display:inline-block;
      padding:0 3px;
      min-width:0.9em;
      text-align:center;
      line-height:1.1;
    }
    .wrong{
      border:3px solid #ef4444;
      border-radius:999px;
    }
    .miss{color:#ef4444;}

    .colActions{ padding:10px 18px 14px; }
    .bigMark{
      width:100%;
      font-size:22px;
      padding:18px 16px;
      border-radius:16px;
      letter-spacing:.5px;
    }

    .starBar{
      background:var(--grey);
      border-top:5px solid var(--line);
      display:grid;
      grid-template-columns: 1fr 1fr;
      align-items:center;
      padding:14px 16px;
      gap:10px;
    }
    .starBox{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:14px;
      font-weight:1000;
      font-size:26px;
      opacity:.65;
      border-radius:14px;
      padding:10px 12px;
      user-select:none;
    }
    .star{
      font-size:44px;
      line-height:1;
    }
    .starActive{
      opacity:1;
      background:#fff;
      border:4px solid var(--line);
    }

    #workBox{ background:#fee2e2; }
    #mastBox{ background:#dcfce7; }

    .actionBar{
      position:sticky;
      bottom:0;
      background:#ffffff;
      border-top:5px solid var(--line);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      z-index:10;
      flex-wrap:wrap;
    }

    .leftCtl{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .btn{
      border:none;
      border-radius:14px;
      padding:12px 14px;
      font-weight:1000;
      cursor:pointer;
      user-select:none;
      box-shadow:0 10px 26px rgba(2,6,23,.12);
      white-space:nowrap;
    }
    .btn:active{transform:translateY(1px);}
    .btn.primary{background:#0ea5e9; color:#fff;}
    .btn.secondary{background:#64748b; color:#fff;}
    .btn.good{background:var(--ok); color:#fff;}
    .btn.danger{background:#dc2626; color:#fff;}
    .btn:disabled{opacity:.45; cursor:not-allowed; transform:none;}

    .pill{
      border:3px solid var(--line);
      border-radius:999px;
      padding:8px 10px;
      font-weight:1000;
      background:#fff;
      white-space:nowrap;
    }
    .pill.scoreBad{ background:#fee2e2; border-color:#dc2626; color:#7f1d1d; }
    .pill.scoreOk{  background:#dcfce7; border-color:#16a34a; color:#14532d; }

    .toggle{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:14px;
      background:#f1f5f9;
      border:1px solid #cbd5e1;
      font-weight:1000;
      white-space:nowrap;
    }
    .toggle input{width:18px; height:18px;}

    .fileBtn{
      position:relative;
      overflow:hidden;
      display:inline-flex;
      align-items:center;
      gap:10px;
    }
    .fileBtn input[type="file"]{
      position:absolute;
      inset:0;
      opacity:0;
      cursor:pointer;
    }

    .credit{
      padding:10px 14px;
      text-align:right;
      color:#64748b;
      font-weight:900;
      font-size:12px;
      border-top:1px solid #e5e7eb;
    }

    /* Teacher Panel (modal) */
    .modal{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:9999;
    }
    .modal.show{display:flex;}
    .modalCard{
      width:min(1100px, calc(100vw - 20px));
      max-height:min(84vh, 780px);
      overflow:auto;
      background:#fff;
      border:5px solid var(--line);
      border-radius:16px;
      box-shadow:var(--shadow);
    }
    .modalHdr{
      position:sticky;
      top:0;
      background:#fff;
      border-bottom:5px solid var(--line);
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      z-index:1;
    }
    .modalHdr h2{
      margin:0;
      font-size:20px;
      font-weight:1000;
    }
    .modalBody{padding:12px 14px 16px;}
    .teacherRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom:12px;
    }
    .tInput{
      border:3px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      font-size:14px;
      outline:none;
      min-width:min(320px, 92vw);
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    th,td{
      border:2px solid #0b0f17;
      padding:8px 8px;
      vertical-align:top;
      font-weight:900;
    }
    th{
      background:#f1f5f9;
      position:sticky;
      top:72px;
      z-index:1;
    }
    .tiny{
      font-size:12px;
      font-weight:900;
      color:#475569;
    }
    .tagOk{display:inline-block; padding:2px 8px; border-radius:999px; background:#dcfce7; color:#14532d; border:2px solid #16a34a;}
    .tagBad{display:inline-block; padding:2px 8px; border-radius:999px; background:#fee2e2; color:#7f1d1d; border:2px solid #dc2626;}
    .btnSmall{
      border:none;
      border-radius:12px;
      padding:10px 12px;
      font-weight:1000;
      cursor:pointer;
      user-select:none;
      box-shadow:0 10px 26px rgba(2,6,23,.12);
      white-space:nowrap;
    }
    .btnSmall:active{transform:translateY(1px);}
    .btnSmall.secondary{background:#64748b; color:#fff;}
    .btnSmall.good{background:var(--ok); color:#fff;}
    .btnSmall.danger{background:#dc2626; color:#fff;}

    @media (max-width: 520px){
      .hdr h1{font-size:26px;}
      .tryHead div{font-size:18px;}
      .idx{font-size:18px;}
      .ans{font-size:18px;}
      .starBox{font-size:18px;}
      .star{font-size:34px;}
      .dateCell{font-size:14px;}
      .bigMark{font-size:20px; padding:16px 14px;}
      th{top:94px;}
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card" id="card">
    <div class="hdr">
      <div class="hdrLeft">
        <h1>I Can Spell</h1>
        <div class="pencil" aria-hidden="true">✎</div>
      </div>

      <div class="nameBox">
        <span>Name:</span>
        <input class="nameInput" id="studentName" placeholder="Teacher to key in pupil name" />
      </div>
    </div>

    <div class="sub">
      <div>
        <div id="subText"><b>Cycle 1 Session 1:</b> Spelling. Mastery is <b>about 80%</b>.</div>
        <div class="tiny" id="modeHint"></div>
      </div>

      <div class="sessionCtl">
        <span class="tag" id="sessionTag">C1S1</span>
        <label class="tiny" for="sessionSel">Session:</label>
        <select class="sel" id="sessionSel" aria-label="Select session"></select>
      </div>
    </div>

    <div class="tryHead">
      <div>1st try</div>
      <div>2nd try</div>
      <div>3rd try</div>
    </div>

    <div class="dateRow">
      <div class="dateCell">
        <span class="dateLabel">Date:</span>
        <span class="dateVal" id="date-1"></span>
      </div>
      <div class="dateCell">
        <span class="dateLabel">Date:</span>
        <span class="dateVal" id="date-2"></span>
        <span class="lockedTag" id="lockTag-2">LOCKED</span>
      </div>
      <div class="dateCell">
        <span class="dateLabel">Date:</span>
        <span class="dateVal" id="date-3"></span>
        <span class="lockedTag" id="lockTag-3">LOCKED</span>
      </div>
    </div>

    <div class="tries" id="tries">
      <div class="tryCol" data-try="1">
        <div class="blankArea" id="area-1"></div>
        <div class="colActions">
          <button class="btn primary bigMark" type="button" data-marktry="1">MARK (1st try)</button>
        </div>
      </div>

      <div class="tryCol" data-try="2">
        <div class="blankArea" id="area-2"></div>
        <div class="colActions">
          <button class="btn primary bigMark" type="button" data-marktry="2">MARK (2nd try)</button>
        </div>
      </div>

      <div class="tryCol" data-try="3">
        <div class="blankArea" id="area-3"></div>
        <div class="colActions">
          <button class="btn primary bigMark" type="button" data-marktry="3">MARK (3rd try)</button>
        </div>
      </div>
    </div>

    <div class="starBar">
      <div class="starBox starActive" id="workBox">
        <div class="star">★</div>
        <div>We’re working on it!</div>
      </div>
      <div class="starBox" id="mastBox">
        <div class="star">☆</div>
        <div>I’ve mastered it! ☺</div>
      </div>
    </div>

    <div class="actionBar">
      <div class="leftCtl">
        <button class="btn secondary" id="unlockAudioBtn" type="button">Unlock Audio</button>

        <div class="toggle">
          <input id="soundOn" type="checkbox" checked>
          <label for="soundOn">Speech On</label>
        </div>

        <span class="pill" id="tryPill">Current: 1st try</span>
        <span class="pill" id="scorePill">Score: —</span>
      </div>

      <div class="leftCtl">
        <button class="btn secondary" id="unlock2Btn" type="button">Unlock 2nd Try</button>
        <button class="btn secondary" id="unlock3Btn" type="button">Unlock 3rd Try</button>

        <button class="btn secondary" id="teacherBtn" type="button">Teacher Panel</button>

        <button class="btn good" id="exportBtn" type="button">Download JSON</button>

        <label class="btn good fileBtn">
          Upload JSON
          <input id="importFile" type="file" accept="application/json">
        </label>

        <button class="btn danger" id="resetBtn" type="button">New Pupil — Clear</button>
      </div>
    </div>

    <div class="credit">Designed by Lim Kim Sze © 2026</div>
  </div>
</div>

<!-- Teacher Panel (Hidden) -->
<div class="modal" id="teacherModal" aria-hidden="true">
  <div class="modalCard">
    <div class="modalHdr">
      <h2>Teacher Panel — PM Records</h2>
      <div class="leftCtl">
        <button class="btnSmall secondary" id="closeTeacher" type="button">Close</button>
      </div>
    </div>

    <div class="modalBody">
      <div class="teacherRow">
        <input class="tInput" id="teacherSearch" placeholder="Search pupil name (e.g., amber)..." />
        <button class="btnSmall good" id="saveRecordBtn" type="button">Save This Pupil’s Result</button>
        <button class="btnSmall secondary" id="exportRecordsBtn" type="button">Export Records JSON</button>

        <label class="btnSmall secondary" style="position:relative; overflow:hidden;">
          Import Records JSON
          <input id="importRecordsFile" type="file" accept="application/json" style="position:absolute; inset:0; opacity:0; cursor:pointer;">
        </label>

        <button class="btnSmall danger" id="clearRecordsBtn" type="button">Clear ALL Records</button>
      </div>

      <div class="tiny" style="margin:8px 0 12px;">
        Stores records in <b>browser local storage</b> (offline). Export regularly as backup.
      </div>

      <div id="recordsWrap"></div>
    </div>
  </div>
</div>

<script>
/* ==========================================================
   RULE (your instruction)
   - For sessions with a defined target phonogram:
     Word is wrong ONLY if the target phonogram is wrong.
   - For other sessions (blending / multisyllabic etc.):
     Whole word must be correct.
   - Students ONLY type spelling (no slashes).
   ========================================================== */

/* ==========================================================
   SESSION BANK
   ========================================================== */
const SESSION_BANK = {
  C1S1:{title:"C1S1 — Review consonant and vowel graphs", markingMode:"full", hint:"Marking: whole word spelling must be correct."},
  C1S2:{title:"C1S2 — Digraphs [ch, sh, th]", markingMode:"phonogram", targets:["ch","sh","th"], hint:"Marking: only the target phonogram must be correct (ch / sh / th)."},
  C1S3:{title:"C1S3 — CCVC words (blend accurately)", markingMode:"full", hint:"Marking: whole word spelling must be correct."},

  C2S1:{title:"C2S1 — Floss rule [-ff, -ll, -ss, -zz]", markingMode:"phonogram", targets:["ff","ll","ss","zz"], hint:"Marking: only the target phonogram must be correct (ff/ll/ss/zz)."},
  C2S2:{title:"C2S2 — -ck rule", markingMode:"phonogram", targets:["ck"], hint:"Marking: only the target phonogram must be correct (ck)."},
  C2S3:{title:"C2S3 — -tch rule", markingMode:"phonogram", targets:["tch"], hint:"Marking: only the target phonogram must be correct (tch)."},

  C3S1:{title:"C3S1 — -dge rule", markingMode:"phonogram", targets:["dge"], hint:"Marking: only the target phonogram must be correct (dge)."},
  C3S2:{title:"C3S2 — Magic-e rule", markingMode:"phonogram", targets:["a_e","e_e","i_e","o_e","u_e"], hint:"Marking: whole word must match the magic-e pattern."},
  C3S3:{title:"C3S3 — CCVC & CCVCe words (blend accurately)", markingMode:"full", hint:"Marking: whole word spelling must be correct."},

  C4S1:{title:"C4S1 — Closed syllables, smaller words, short vowel", markingMode:"full", hint:"Marking: whole word spelling must be correct."},
  C4S2:{title:"C4S2 — Open syllables, long vowel sounds", markingMode:"full", hint:"Marking: whole word spelling must be correct."},
  C4S3:{title:"C4S3 — VC/CV words", markingMode:"full", hint:"Marking: whole word spelling must be correct."},

  C5S1:{title:"C5S1 — VC/V, V/CV words", markingMode:"full", hint:"Marking: whole word spelling must be correct."},
  C5S2:{title:"C5S2 — Schwa concept", markingMode:"full", hint:"Marking: whole word spelling must be correct."},
  C5S3:{title:"C5S3 — CVCC & multisyllabic words", markingMode:"full", hint:"Marking: whole word spelling must be correct."},

  C6S1:{title:"C6S1 — Consonant -le blends [-ble, -dle]", markingMode:"phonogram", targets:["ble","dle"], hint:"Marking: only the target phonogram must be correct (-ble / -dle)."},
  C6S2:{title:"C6S2 — Consonant -le blends [-ple, -tle, -gle]", markingMode:"phonogram", targets:["ple","tle","gle"], hint:"Marking: only the target phonogram must be correct (-ple / -tle / -gle)."},
  C6S3:{title:"C6S3 — r-controlled vowels [ar, or]", markingMode:"phonogram", targets:["ar","or"], hint:"Marking: only the target phonogram must be correct (ar / or)."},

  C7S1:{title:"C7S1 — r-controlled vowels [ir, er, ur]", markingMode:"phonogram", targets:["ir","er","ur"], hint:"Marking: only the target phonogram must be correct (ir / er / ur)."},
  C7S2:{title:"C7S2 — 'y' as /ĭ/, 'y' as /ē/", markingMode:"phonogram", targets:["y"], hint:"Marking: focus on the target phonogram (y)."},
  C7S3:{title:"C7S3 — CCVCC & multisyllabic words (blend/syllabicate)", markingMode:"full", hint:"Marking: whole word spelling must be correct."},

  C8S1:{title:"C8S1 — Soft 'c' & Soft 'g' rule", markingMode:"phonogram", targets:["c","g"], hint:"Marking: focus on the target phonogram (soft c / soft g)."},
  C8S2:{title:"C8S2 — Vowel teams ('ay', 'ai' say /ā/)", markingMode:"phonogram", targets:["ay","ai"], hint:"Marking: only the target phonogram must be correct (ay / ai)."},
  C8S3:{title:"C8S3 — Multisyllabic words", markingMode:"full", hint:"Marking: whole word spelling must be correct."},
    C9S1:{title:"C9S1 — Vowel team 'ee' says /ē/", markingMode:"phonogram", targets:["ee"], hint:"Marking: only the target phonogram must be correct (ee)."},
  C9S2:{title:"C9S2 — Vowel team 'ea' says /ē/ or /ĕ/", markingMode:"phonogram", targets:["ea"], hint:"Marking: only the target phonogram must be correct (ea)."},
   /* ===== Cycle 9 ===== */
  C9S1:{title:"C9S1 — Vowel team [ee] says /ē/", markingMode:"phonogram", targets:["ee"], hint:"Marking: only the target phonogram must be correct (ee)."},
  C9S2:{title:"C9S2 — Vowel team [ea] says /ē/ or /ĕ/", markingMode:"phonogram", targets:["ea"], hint:"Marking: only the target phonogram must be correct (ea)."},
  C9S3:{title:"C9S3 — Vowel team [ie] says /ī/ or /ē/", markingMode:"phonogram", targets:["ie"], hint:"Marking: only the target phonogram must be correct (ie)."},

  /* ===== Cycle 10 ===== */
  C10S1:{title:"C10S1 — Vowel team [ei] says /ē/ or /ā/", markingMode:"phonogram", targets:["ei"], hint:"Marking: only the target phonogram must be correct (ei)."},
  C10S2:{title:"C10S2 — Vowel team [ey] says /ā/ or /ē/", markingMode:"phonogram", targets:["ey"], hint:"Marking: only the target phonogram must be correct (ey)."},
  C10S3:{title:"C10S3 — CCCVC, CCCVCC and multisyllabic words", markingMode:"full", hint:"Marking: whole word spelling must be correct."},

  /* ===== Cycle 11 ===== */
  C11S1:{title:"C11S1 — Vowel teams [oa, ow] says /ō/", markingMode:"phonogram", targets:["oa","ow"], hint:"Marking: only the target phonogram must be correct (oa / ow)."},
  C11S2:{title:"C11S2 — Vowel team [oo] long & short sounds", markingMode:"phonogram", targets:["oo"], hint:"Marking: only the target phonogram must be correct (oo)."},
  C11S3:{title:"C11S3 — Vowel teams [ue, ew, ui] say /oo/", markingMode:"phonogram", targets:["ue","ew","ui"], hint:"Marking: only the target phonogram must be correct (ue / ew / ui)."},

  /* ===== Cycle 12 ===== */
  C12S1:{title:"C12S1 — Vowel teams [ue, ew] say /ū/", markingMode:"phonogram", targets:["ue","ew"], hint:"Marking: only the target phonogram must be correct (ue / ew)."},
  C12S2:{title:"C12S2 — Vowel team [aw] says /aw/", markingMode:"phonogram", targets:["aw"], hint:"Marking: only the target phonogram must be correct (aw)."},
  C12S3:{title:"C12S3 — Multisyllabic words with vowel teams", markingMode:"full", hint:"Marking: whole word spelling must be correct."},

  /* ===== Cycle 13 ===== */
  C13S1:{title:"C13S1 — Vowel teams [ou, ow] says /ow/", markingMode:"phonogram", targets:["ou","ow"], hint:"Marking: only the target phonogram must be correct (ou / ow)."},
  C13S2:{title:"C13S2 — Vowel teams [oi, oy] say /oi/", markingMode:"phonogram", targets:["oi","oy"], hint:"Marking: only the target phonogram must be correct (oi / oy)."},
  C13S3:{title:"C13S3 — Vowel team [igh] says /ī/", markingMode:"phonogram", targets:["igh"], hint:"Marking: only the target phonogram must be correct (igh)."},
  /* ===== Cycle 14 ===== */
  C14S1:{title:"C14S1 — Consonant digraph [kn] says /n/", markingMode:"phonogram", targets:["kn"], hint:"Marking: only the target phonogram must be correct (kn)."},
  C14S2:{title:"C14S2 — Consonant digraph [ng] says /ŋ/, [nk] says /ŋk/", markingMode:"phonogram", targets:["ng","nk"], hint:"Marking: only the target phonogram must be correct (ng / nk)."},
  C14S3:{title:"C14S3 — Multisyllabic words", markingMode:"full", hint:"Marking: whole word spelling must be correct."},
  /* ===== Cycle 15 ===== */
  C15S1:{title:"C15S1 — Revision of multisyllabic words", markingMode:"full", hint:"Marking: whole word spelling must be correct."},
  C15S2:{title:"C15S2 — Revision of multisyllabic words", markingMode:"full", hint:"Marking: whole word spelling must be correct."},
  C15S3:{title:"C15S3 — Revision of multisyllabic words", markingMode:"full", hint:"Marking: whole word spelling must be correct."},
  /* ===== Cycle 16 ===== */
  C16S1:{title:"C16S1 — Plural suffixes '-s' and '-es'", markingMode:"affix", targets:["es","s"], hint:"Marking: only the target suffix must be correct (-s / -es)."},
C16S2:{title:"C16S2 — Past Tense Suffix '-ed'", markingMode:"affix", targets:["ed"], hint:"Marking: only the target suffix must be correct (-ed)."},
C16S3:{title:"C16S3 — Prefixes 'un-' and 'in-'", markingMode:"affix", targets:["un","in"], hint:"Marking: only the target prefix must be correct (un- / in-)."},

C17S1:{title:"C17S1 — Suffixes '-ing' and '-ful'", markingMode:"affix", targets:["ing","ful"], hint:"Marking: only the target suffix must be correct (-ing / -ful)."},
C17S2:{title:"C17S2 — Prefixes 're-' and 'dis-'", markingMode:"affix", targets:["re","dis"], hint:"Marking: only the target prefix must be correct (re- / dis-)."},
C17S3:{title:"C17S3 — Comparative/Superlative suffixes '-er' and '-est'", markingMode:"affix", targets:["est","er"], hint:"Marking: only the target suffix must be correct (-er / -est)."},

C18S1:{title:"C18S1 — Prefix 'mis-'", markingMode:"affix", targets:["mis"], hint:"Marking: only the target prefix must be correct (mis-)."},
C18S2:{title:"C18S2 — Prefix 'pre-'", markingMode:"affix", targets:["pre"], hint:"Marking: only the target prefix must be correct (pre-)."},
C18S3:{title:"C18S3 — Suffix '-less'", markingMode:"affix", targets:["less"], hint:"Marking: only the target suffix must be correct (-less)."}










};

/* ==========================================================
   TRIES BANK (Spelling words + sentences)
   Each try has exactly 2 words (to match your booklet layout).
   ========================================================== */
const TRIES_BANK = {
  C1S1:{
    1:[{word:"map",sentence:"Map. We can use a map to find our way home. Map."},{word:"cut",sentence:"Cut. I cut my finger during art class. Cut."}],
    2:[{word:"fix",sentence:"Fix. We have to fix the broken chair. Fix."},{word:"sun",sentence:"Sun. The sun is shining so brightly today. Sun."}],
    3:[{word:"hot",sentence:"Hot. Water becomes very hot after it is boiled. Hot."},{word:"hid",sentence:"Hid. He hid from his friends during the game. Hid."}]
  },
  C1S2:{
    1:[{word:"much",sentence:"Much. I love my parents so much. Much."},{word:"with",sentence:"With. I went to the zoo with my family over the weekend. With."}],
    2:[{word:"shut",sentence:"Shut. Please shut the door behind you. Shut."},{word:"that",sentence:"That. This is my table, and that is yours. That."}],
    3:[{word:"chat",sentence:"Chat. I had a long chat with my teacher. Chat."},{word:"then",sentence:"Then. I packed my bag and then went to school. Then."}]
  },
  C1S3:{
    1:[{word:"spot",sentence:"Spot. There is a black spot on that dog. Spot."},{word:"gram",sentence:"Gram. What are some items that weigh a gram? Gram."}],
    2:[{word:"plan",sentence:"Plan. Let us plan a trip to the zoo. Plan."},{word:"skin",sentence:"Skin. Our is covered with skin. Skin."}],
    3:[{word:"step",sentence:"Step. Take a step forward so you can see better. Step."},{word:"plus",sentence:"Plus. One plus two is equals to three. Plus."}]
  },

  C2S1:{
    1:[{word:"fill",sentence:"Fill. Fill up your water bottle before PE lesson. Fill."},{word:"dress",sentence:"Dress. She bought a new dress to wear for her birthday party. Dress."}],
    2:[{word:"stuff",sentence:"Stuff. Eat slowly and do not stuff the food into your mouth. Stuff."},{word:"miss",sentence:"Miss. I will miss my friend when he goes to another school. Miss."}],
    3:[{word:"less",sentence:"Less. He ate less rice today as he was not hungry. Less."},{word:"jazz",sentence:"Jazz. He listens to jazz music to relax. Jazz."}]
  },
  C2S2:{
    1:[{word:"clock",sentence:"Clock. I can hear the clock ticking away. Clock."},{word:"quick",sentence:"Quick. She was very quick to finish her homework. Quick."}],
    2:[{word:"pick",sentence:"Pick. We should pick a place to dine at. Pick."},{word:"rock",sentence:"Rock. He threw a rock and broke the window. Rock."}],
    3:[{word:"check",sentence:"Check. Please check your work before you submit it. Check."},{word:"track",sentence:"Track. We run on the school track during PE. Track."}]
  },
  C2S3:{
    1:[{word:"catch",sentence:"Catch. I jumped up to catch the ball. Catch."},{word:"stitch",sentence:"Stitch. My mother helped to stitch my torn pants. Stitch."}],
    2:[{word:"pitch",sentence:"Pitch. She sings in a very high pitch. Pitch."},{word:"hatch",sentence:"Hatch. The chicken’s eggs will hatch in a week. Hatch."}],
    3:[{word:"clutch",sentence:"Clutch. The children clutch their mother’s hand tightly. Clutch."},{word:"fetch",sentence:"Fetch. My grandparents fetch me home after school. Fetch."}]
  },

  C3S1:{
    1:[{word:"judge",sentence:"Judge. The judge decided that the person was guilty. Judge."},{word:"fridge",sentence:"Fridge. She placed the ice-cream in the fridge. Fridge."}],
    2:[{word:"pledge",sentence:"Pledge. We say the Singapore pledge every morning. Pledge."},{word:"badge",sentence:"Badge. He pinned the badge to his shirt. Badge."}],
    3:[{word:"bridge",sentence:"Bridge. We will reach the place after we cross this bridge. Bridge."},{word:"lodge",sentence:"Lodge. We stayed in a lodge during our vacation. Lodge."}]
  },
  C3S2:{
    1:[{word:"shape",sentence:"Shape. The square is my favourite shape. Shape."},{word:"these",sentence:"These. These are my favourite food. These."}],
    2:[{word:"hope",sentence:"Hope. I hope I get a good score on my test. Hope."},{word:"five",sentence:"Five. My little sister is five years old. Five."}],
    3:[{word:"side",sentence:"Side. My friend sits on my right side in class. Side."},{word:"tube",sentence:"Tube. I bought a tube of toothpaste from the supermarket. Tube."}]
  },
  C3S3:{
    1:[{word:"frog",sentence:"Frog. The frog jumped from one leaf to another. Frog."},{word:"plane",sentence:"Plane. We took a plane to England. Plane."}],
    2:[{word:"shrug",sentence:"Shrug. I shrug when I do not know the answer. Shrug."},{word:"state",sentence:"State. Ice is a solid state of water. State."}],
    3:[{word:"broke",sentence:"Broke. I broke my glasses when I fell down. Broke."},{word:"stop",sentence:"Stop. Stop calling your classmates names. Stop."}]
  },

  C4S1:{
    1:[{word:"backpack",sentence:"Backpack. The backpack was too heavy for my shoulders. Backpack."},{word:"cannot",sentence:"Cannot. I cannot see the whiteboard. Cannot."}],
    2:[{word:"sunset",sentence:"Sunset. I love watching the sunset in the evening. Sunset."},{word:"kidnap",sentence:"Kidnap. It is a crime to kidnap another person. Kidnap."}],
    3:[{word:"pumpkin",sentence:"Pumpkin. A pumpkin is a round orange melon. Pumpkin."},{word:"upset",sentence:"Upset. The boy felt upset when he lost his toy. Upset."}]
  },
  C4S2:{
    1:[{word:"hero",sentence:"Hero. Batman is my favourite hero. Hero."},{word:"me",sentence:"Me. Please give me a call later. Me."}],
    2:[{word:"halo",sentence:"Halo. There was a halo around the sun. Halo."},{word:"logo",sentence:"Logo. She designed the logo on that shirt. Logo."}],
    3:[{word:"go",sentence:"Go. I go to school everyday. Go."},{word:"zero",sentence:"Zero. Zero is the number that comes before one. Zero."}]
  },
  C4S3:{
    1:[{word:"until",sentence:"Until. I did my homework until dinner time. Until."},{word:"hello",sentence:"Hello. We dropped by to say hello. Hello."}],
    2:[{word:"muffin",sentence:"Muffin. I ate a muffin during snack time. Muffin."},{word:"admit",sentence:"Admit. You must admit to your mistake. Admit."}],
    3:[{word:"rabbit",sentence:"Rabbit. I have a white fluffy pet rabbit. Rabbit."},{word:"picnic",sentence:"Picnic. We had a picnic at the park over the weekend. Picnic."}]
  },

  C5S1:{
    1:[{word:"robot",sentence:"Robot. He built a robot vacuum to clean the house. Robot."},{word:"limit",sentence:"Limit. The time limit for the test is 1 hour. Limit."}],
    2:[{word:"rapid",sentence:"Rapid. The patient made a rapid recovery. Rapid."},{word:"began",sentence:"Began. He began to sweat as he ran. Began."}],
    3:[{word:"tulip",sentence:"Tulip. My favourite flower is the tulip.  Tulip."},{word:"habit",sentence:"Habit. Washing hands before eating is a good habit. Habit."}]
  },
  C5S2:{
    1:[{word:"minus",sentence:"Minus. Ten minus 2 is eight. Minus."},{word:"human",sentence:"Human. Treat all human beings equally. Human."}],
    2:[{word:"ago",sentence:"Ago. Nine years ago, I was born. Ago."},{word:"bottom",sentence:"Bottom. The fish was swimming at the bottom of the tank. Bottom."}],
    3:[{word:"problem",sentence:"Problem. You can look for me if you face a problem. Problem."},{word:"travel",sentence:"Travel. I hope to travel to Japan during the school holidays. Travel."}]
  },
  C5S3:{
    1:[{word:"soft",sentence:"Soft. My blanket is very soft. Soft."},{word:"tadpole",sentence:"Tadpole. The tadpole grew into a frog. Tadpole."}],
    2:[{word:"must",sentence:"Must. We must clear our plates after eating. Must."},{word:"suppose",sentence:"Suppose. I suppose I’ll see you at the party later. Suppose."}],
    3:[{word:"help",sentence:"Help. Please help me carry some books. Help."},{word:"himself",sentence:"Himself. Tim was alone eating by himself. Himself."}]
  },

  C6S1:{
    1:[{word:"able",sentence:"Able. He was able to carry the chairs up to class. Able."},{word:"middle",sentence:"Middle. I sit in the middle of my two friends in class. Middle."}],
    2:[{word:"candle",sentence:"Candle. We lit the candle on the birthday cake. Candle."},{word:"grumble",sentence:"Grumble. He tends to grumble about the hot weather. Grumble."}],
    3:[{word:"tremble",sentence:"Tremble. The cold made her whole body tremble. Tremble."},{word:"paddle",sentence:"Paddle. I learnt to paddle a canoe over the holidays. Paddle."}]
  },
  C6S2:{
    1:[{word:"smuggle",sentence:"Smuggle. The men tried to smuggle pets out of the country. Smuggle."},{word:"wiggle",sentence:"Wiggle. Can you wiggle your ears? Wiggle."}],
    2:[{word:"kettle",sentence:"Kettle. Pour the hot water out from the kettle. Kettle."},{word:"crumple",sentence:"Crumple. Do not crumple my clothes. Crumple."}],
    3:[{word:"dimple",sentence:"Dimple. The boy has a dimple on his left cheek. Dimple."},{word:"bottle",sentence:"Bottle. Remember to fill your bottle up with water. Bottle."}]
  },
  C6S3:{
    1:[{word:"far",sentence:"Far. Let us see how far we can run. Far."},{word:"popcorn",sentence:"Popcorn. I ate a bag of popcorn at the movies. Popcorn."}],
    2:[{word:"short",sentence:"Short. My baby brother is still quite short. Short."},{word:"mark",sentence:"Mark. You are already at the halfway mark of the race. Mark."}],
    3:[{word:"sharp",sentence:"Sharp. The blade of the knife is very sharp. Sharp."},{word:"platform",sentence:"Platform. She stepped off the train onto the platform. Platform."}]
  },

  C7S1:{
    1:[{word:"girl",sentence:"Girl. My close friend is a girl. Girl."},{word:"person",sentence:"Person. You are the happiest person I have ever met. Person."}],
    2:[{word:"third",sentence:"Third. Siti came in third in the race. Third."},{word:"turtle",sentence:"Turtle. The turtle lives in the water most of the time. Turtle."}],
    3:[{word:"corner",sentence:"Corner. He hid in the corner during the game so no one could find him. Corner."},{word:"church",sentence:"Church. I go to the church every Sunday. Church."}]
  },
  C7S2:{
    1:[{word:"fly",sentence:"Fly. Look at that plane fly in the sky! Fly."},{word:"baby",sentence:"Baby. My mother just gave birth to a baby sister. Baby."}],
    2:[{word:"cry",sentence:"Cry. I do not like to cry in front of my friends. Cry."},{word:"study",sentence:"Study. I should study harder for the next test. Study."}],
    3:[{word:"sky",sentence:"Sky. The sky is very dark, I think it is going to rain. Sky."},{word:"twenty",sentence:"Twenty. Ten plus ten equals to twenty. Twenty."}]
  },
  C7S3:{
    1:[{word:"split",sentence:"Split. Let us split this apple into two. Split."},{word:"subtract",sentence:"Subtract. If we subtract two from six, we will get four. Subtract."}],
    2:[{word:"print",sentence:"Print. We should print out these photos. Print."},{word:"thirsty",sentence:"Thirsty. I felt thirsty after my run. Thirsty."}],
    3:[{word:"stand",sentence:"Stand. The teacher asked the students to stand up. Stand."},{word:"marble",sentence:"Marble. My uncle gave me a marble to play with. Marble."}]
  },

  C8S1:{
    1:[{word:"cent",sentence:"Cent. He did not have a single cent with him. Cent."},{word:"digit",sentence:"Digit. What is the first digit of your phone number? Digit."}],
    2:[{word:"space",sentence:"Space. Is there space for my bag in the drawer? Space."},{word:"magic",sentence:"Magic. Do you enjoy seeing magic tricks? Magic."}],
    3:[{word:"face",sentence:"Face. I wash my face every morning after I wake up. Face."},{word:"age",sentence:"Age. My friend and I are of the same age. Age."}]
  },
  C8S2:{
    1:[{word:"play",sentence:"Play. We play in the field during recess. Play."},{word:"train",sentence:"Train. My father takes the train to work every day. Train."}],
    2:[{word:"stay",sentence:"Stay. My family and I stay across the street. Stay."},{word:"drain",sentence:"Drain. On rainy days, the water in the drain would overflow. Drain."}],
    3:[{word:"away",sentence:"Away. I threw the leftover food away. Away."},{word:"gain",sentence:"Gain. Reading books can help us to gain knowledge. Gain."}]
  },
  C8S3:{
    1:[{word:"railway",sentence:"Railway. We headed to the railway station to board our train. Railway."},{word:"circus",sentence:"Circus. The clowns in this circus are very funny! Circus."}],
    2:[{word:"concert",sentence:"Concert. I enjoyed the Children’s Day concert. Concert."},{word:"painter",sentence:"Painter. The painter applied a fresh coat of paint on the new building. Painter."}],
    3:[{word:"gentle",sentence:"Gentle. You need to be gentle with the little puppy. Gentle."},{word:"crayon",sentence:"Crayon. The boy coloured his drawing with a green crayon. Crayon."}]
  },
    /* =========================
     Cycle 9
     Try 1 = PM (left)
     Try 2 = PM during DI (middle)
     Try 3 = PM during DI (right)
     ========================= */
  C9S1:{
    1:[{word:"green",sentence:"Green. I have never seen a cat with green eyes. Green."},{word:"feel",sentence:"Feel. I feel awful about losing my favourite book. Feel."}],
    2:[{word:"sleep",sentence:"Sleep. Do you know that fish sleep with their eyes open? Sleep."},{word:"three",sentence:"Three. He was tired after running three laps. Three."}],
    3:[{word:"seen",sentence:"Seen. I have seen this lady before. Seen."},{word:"week",sentence:"Week. There are seven days in a week. Week."}]
  },
  C9S2:{
    1:[{word:"ready",sentence:"Ready. I will be ready to leave in five minutes. Ready."},{word:"least",sentence:"Least. She had the least amount of points. Least."}],
    2:[{word:"breath",sentence:"Breath. She took a deep breath before diving. Breath."},{word:"reach",sentence:"Reach. He could not reach the upper shelf. Reach."}],
    3:[{word:"thread",sentence:"Thread. It is not easy to put a thread through a needle. Thread."},{word:"treat",sentence:"Treat. We should treat everyone with kindness. Treat."}]
  },
  C9S3:{
    1:[{word:"cried",sentence:"Cried. The toddler cried when he fell down. Cried."},{word:"field",sentence:"Field. We enjoy playing soccer at the field. Field."}],
    2:[{word:"lie",sentence:"Lie. He decided to lie down as he was feeling tired. Lie."},{word:"piece",sentence:"Piece. Would you like a piece of bread? Piece."}],
    3:[{word:"pie",sentence:"Pie. My mother baked an apple pie for dessert. Pie."},{word:"grief",sentence:"Grief. Josie was filled with grief when she lost her pet. Grief."}]
  },

  /* =========================
     Cycle 10 (ORDER FIXED)
     Try 1 = left, Try 2 = middle, Try 3 = right
     ========================= */
  C10S1:{
    1:[{word:"seize",sentence:"Seize. Seize the chance while you can! Seize."},{word:"vein",sentence:"Vein. The nurse injected the vaccine into his vein. Vein."}],
    2:[{word:"protein",sentence:"Protein. Meat contains a high amount of protein. Protein."},{word:"rein",sentence:"Rein. Pull on the left rein to make the horse go left. Rein."}],
    3:[{word:"perceive",sentence:"Perceive. I perceive the girl to be a kind person. Perceive."},{word:"veil",sentence:"Veil. The groom lifted the veil covering the bride’s face. Veil."}]
  },
  C10S2:{
    1:[{word:"they",sentence:"They. They sat together at the table for lunch. They."},{word:"valley",sentence:"Valley. There is a deep valley between the mountains. Valley."}],
    2:[{word:"survey",sentence:"Survey. They were asked to complete a survey. Survey."},{word:"key",sentence:"Key. We used the key to unlock the gate. Key."}],
    3:[{word:"prey",sentence:"Prey. The tiger waited for its prey. Prey."},{word:"chimney",sentence:"Chimney. Thick smoke came out of the chimney. Chimney."}]
  },
  C10S3:{
    1:[{word:"street",sentence:"Street. He lives on this street. Street."},{word:"achieve",sentence:"Achieve. I hope to achieve my goal this year. Achieve."}],
    2:[{word:"spread",sentence:"Spread. The good news spread quickly. Spread."},{word:"trolley",sentence:"Trolley. The waiter pushed the trolley carefully. Trolley."}],
    3:[{word:"stream",sentence:"Stream. We waded across the shallow stream. Stream."},{word:"convey",sentence:"Convey. Can you convey this message to him? Convey."}]
  },

  /* =========================
     Cycle 11
     ========================= */
  C11S1:{
    1:[{word:"float",sentence:"Float. Coconuts float on water. Float."},{word:"shown",sentence:"Shown. The movie will be shown in theatres. Shown."}],
    2:[{word:"load",sentence:"Load. The man was carrying a heavy load. Load."},{word:"grow",sentence:"Grow. Drinking milk can help you to grow taller. Grow."}],
    3:[{word:"groan",sentence:"Groan. She let out a groan when she fell. Groan."},{word:"throw",sentence:"Throw. Can you throw the rubbish into the bin? Throw."}]
  },
  C11S2:{
    1:[{word:"hood",sentence:"Hood. She is wearing a red cloak with a hood. Hood."},{word:"room",sentence:"Room. I was told to clean up my room. Room."}],
    2:[{word:"took",sentence:"Took. He took his result slip from the teacher. Took."},{word:"food",sentence:"Food. Chicken rice is my favourite food. Food."}],
    3:[{word:"stood",sentence:"Stood. He stood up to answer the question. Stood."},{word:"noodle",sentence:"Noodle. I ate a plate of noodles for dinner. Noodle."}]
  },
  C11S3:{
    1:[{word:"true",sentence:"True. It is true that the sun rises in the East and sets in the West. True."},{word:"juice",sentence:"Juice. I drink a glass of apple juice every morning. Juice."}],
    2:[{word:"flew",sentence:"Flew. The bird flew away quickly when it saw the cat. Flew."},{word:"clue",sentence:"Clue. The detective found an important clue to solve the case. Clue."}],
    3:[{word:"cruise",sentence:"Cruise. My parents are bringing me on a cruise during the school holidays. Cruise."},{word:"threw",sentence:"Threw. She threw the ball to her friend. Threw."}]
  },

  /* =========================
     Cycle 12
     ========================= */
  C12S1:{
    1:[{word:"due",sentence:"Due. Your homework is due tomorrow. Due."},{word:"stew",sentence:"Stew. My mother cooked beef stew for dinner. Stew."}],
    2:[{word:"rescue",sentence:"Rescue. He managed to rescue the drowning puppy. Rescue."},{word:"dew",sentence:"Dew. The grass was wet with morning dew. Dew."}],
    3:[{word:"value",sentence:"Value. These coins are not of equal value. Value."},{word:"few",sentence:"Few. I borrowed a few books from the library. Few."}]
  },
  C12S2:{
    1:[{word:"draw",sentence:"Draw. Please draw a card from the deck. Draw."},{word:"hawk",sentence:"Hawk. The hawk caught its prey in an instant. Hawk."}],
    2:[{word:"straw",sentence:"Straw. She drank the juice through a straw. Straw."},{word:"saw",sentence:"Saw. I saw her at the mall last week. Saw."}],
    3:[{word:"dawn",sentence:"Dawn. I woke up at dawn to exercise at the park. Dawn."},{word:"jigsaw",sentence:"Jigsaw. I enjoy playing with jigsaw puzzles. Jigsaw."}]
  },
  C12S3:{
    1:[{word:"hollow",sentence:"Hollow. The squirrel lives in the hollow tree. Hollow."},{word:"jewel",sentence:"Jewel. The robbers stole the expensive jewel. Jewel."}],
    2:[{word:"shadow",sentence:"Shadow. The dog was afraid of its own shadow. Shadow."},{word:"suitable",sentence:"Suitable. This shirt is not suitable for me. Suitable."}],
    3:[{word:"strawberry",sentence:"Strawberry. He spread strawberry jam on the toast. Strawberry."},{word:"sailboat",sentence:"Sailboat. My uncle took us on a trip on his sailboat. Sailboat."}]
  },

  /* =========================
     Cycle 13
     ========================= */
  C13S1:{
    1:[{word:"sound",sentence:"Sound. Did you hear that sound? Sound."},{word:"town",sentence:"Town. I took the bus to town. Town."}],
    2:[{word:"amount",sentence:"Amount. He brought a large amount of money to the bank. Amount."},{word:"brown",sentence:"Brown. I saw a big brown bear at the zoo. Brown."}],
    3:[{word:"shout",sentence:"Shout. You’ll wake the baby up if you shout too loudly. Shout."},{word:"growl",sentence:"Growl. Be careful if you hear a dog start to growl. Growl."}]
  },
  C13S2:{
    1:[{word:"point",sentence:"Point. Point to the first syllable in this word. Point."},{word:"boy",sentence:"Boy. The boy standing over there is my brother. Boy."}],
    2:[{word:"voice",sentence:"Voice. My teacher has a loud voice. Voice."},{word:"ploy",sentence:"Ploy. His ‘illness’ was a part of his ploy to skip class. Ploy."}],
    3:[{word:"soil",sentence:"Soil. He poured soil into his garden pot. Soil."},{word:"enjoy",sentence:"Enjoy. I enjoy attending art classes. Enjoy."}]
  },
  C13S3:{
    1:[{word:"right",sentence:"Right. Her house is on the right. Right."},{word:"sight",sentence:"Sight. I lost sight of my dog in the darkness. Sight."}],
    2:[{word:"light",sentence:"Light. Remember to switch off the lights when you leave the room. Light."},{word:"delight",sentence:"Delight. It was such a delight to meet you! Delight."}],
    3:[{word:"fight",sentence:"Fight. He broke his nose in the fight. Fight."},{word:"sunlight",sentence:"Sunlight. I was dazzled by the sunlight. Sunlight."}]
  },
  /* =========================
     Cycle 14
     ========================= */

  C14S1:{
    1:[
      {word:"knot",   sentence:"Knot. I can’t untie the dead knot on the rope. Knot."},
      {word:"knuckle",sentence:"Knuckle. She cracked her knuckle loudly. Knuckle."}
    ],
    2:[
      {word:"knife", sentence:"Knife. Please be careful when you handle a knife. Knife."},
      {word:"knit",  sentence:"Knit. She loves to knit blankets for her dogs. Knit."}
    ],
    3:[
      {word:"knight",sentence:"Knight. The knight protects the king and queen. Knight."},
      {word:"known", sentence:"Known. I have known you since I was ten. Known."}
    ]
  },

  C14S2:{
    1:[
      {word:"morning",sentence:"Morning. I go for a jog every morning. Morning."},
      {word:"blank",  sentence:"Blank. Our teacher gave us a blank sheet of paper. Blank."}
    ],
    2:[
      {word:"lung",  sentence:"Lung. The lung is an organ that helps us breathe. Lung."},
      {word:"think", sentence:"Think. Think about what you want to be when you grow up. Think."}
    ],
    3:[
      {word:"king",  sentence:"King. The king lives in a huge castle. King."},
      {word:"clunk", sentence:"Clunk. He shut the van door with a clunk. Clunk."}
    ]
  },

  C14S3:{
    1:[
      {word:"kneecap",  sentence:"Kneecap. The kneecap is a small bone. Kneecap."},
      {word:"highway",  sentence:"Highway. Traffic moves quickly on the highway. Highway."}
    ],
    2:[
      {word:"boomerang",sentence:"Boomerang. A boomerang is a curved throwing stick. Boomerang."},
      {word:"toilet",   sentence:"Toilet. Do visit the toilet before you head out. Toilet."}
    ],
    3:[
      {word:"blanket", sentence:"Blanket. She curled up under her blanket. Blanket."},
      {word:"belong",  sentence:"Belong. That item does not belong to you. Belong."}
    ]
  },
  /* =========================
     Cycle 15
     ========================= */

  C15S1:{
    1:[
      {word:"delay",   sentence:"Delay. There was a delay in the food delivery. Delay."},
      {word:"daytime", sentence:"Daytime. I enjoy going for a jog in the daytime. Daytime."}
    ],
    2:[
      {word:"afraid", sentence:"Afraid. My sister is afraid of lizards. Afraid."},
      {word:"needle", sentence:"Needle. He gave a shout when he was pricked by the needle. Needle."}
    ],
    3:[
      {word:"weather", sentence:"Weather. The sunny weather is perfect for a hike. Weather."},
      {word:"leader",  sentence:"Leader. She has what it takes to be a good leader. Leader."}
    ]
  },

  C15S2:{
    1:[
      {word:"between", sentence:"Between. The boy stood between his parents. Between."},
      {word:"jersey",  sentence:"Jersey. He wore his new jersey for the football match. Jersey."}
    ],
    2:[
      {word:"highway",  sentence:"Highway. The cars travel very quickly on the highway. Highway."},
      {word:"sightsee", sentence:"Sightsee. I brought my friend from overseas around to sightsee. Sightsee."}
    ],
    3:[
      {word:"forfeit", sentence:"Forfeit. If you do not complete the form, you will forfeit the prize you have won. Forfeit."},
      {word:"around",  sentence:"Around. We ran around the school during PE lesson. Around."}
    ]
  },
   C15S3:{
    1:[
      {word:"elbow",     sentence:"Elbow. She hurt her elbow when she fell down. Elbow."},
      {word:"chipmunk",  sentence:"Chipmunk. I saw a chipmunk on the tree branch. Chipmunk."}
    ],
    2:[
      {word:"footprint", sentence:"Footprint. I left my footprint in the sand. Footprint."},
      {word:"allow",     sentence:"Allow. The teachers allow us to go for an early break. Allow."}
    ],
    3:[
      {word:"approach",  sentence:"Approach. We were told not to approach the wild animals at the safari. Approach."},
      {word:"raincoat",  sentence:"Raincoat. We quickly put on our raincoat when it started raining on our hike. Raincoat."}
    ]
  },
  /* =========================
     Cycle 16
     ========================= */

  C16S1:{
    /* Plural -s / -es */

    1:[ // PM (left column)
      {word:"digits", sentence:"Digits. My phone number has eight digits in total. Digits."},
      {word:"boxes",  sentence:"Boxes. Could you help me carry these boxes upstairs? Boxes."}
    ],

    2:[ // PM during DI (middle column)
      {word:"books",   sentence:"Books. I borrowed five books from the library. Books."},
      {word:"matches", sentence:"Matches. The soccer team is competing in five more matches. Matches."}
    ],

    3:[ // PM during DI (right column)
      {word:"nights",  sentence:"Nights. There are some nights when I can’t fall asleep. Nights."},
      {word:"benches", sentence:"Benches. The children sat on the park benches. Benches."}
    ]
  },

  C16S2:{
    /* Past tense -ed */

    1:[ // PM (left column)
      {word:"crawled",  sentence:"Crawled. The lizard crawled across the field. Crawled."},
      {word:"reached",  sentence:"Reached. We reached our destination at noon. Reached."},
      {word:"visited",  sentence:"Visited. I visited my grandmother over the weekend. Visited."}
    ],

    2:[ // PM during DI (middle column)
      {word:"played",  sentence:"Played. The students played in the field after school. Played."},
      {word:"picked",  sentence:"Picked. These fruits are fresh, I picked them this morning. Picked."},
      {word:"rested",  sentence:"Rested. The hikers rested for an hour before carrying on. Rested."}
    ],

    3:[ // PM during DI (right column)
      {word:"walked",  sentence:"Walked. I walked to my friend’s house which was nearby. Walked."},
      {word:"fished",  sentence:"Fished. The man fished all night and caught ten fishes. Fished."},
      {word:"waited",  sentence:"Waited. The students waited for the teacher at the canteen. Waited."}
    ]
  },
  C16S3:{
    /* Prefixes un- / in- */

    1:[ // PM (left column)
      {word:"unscrew",   sentence:"Unscrew. I can’t unscrew the lid of this jar as it is too tight. Unscrew."},
      {word:"incomplete",sentence:"Incomplete. My homework was incomplete when I submitted it. Incomplete."}
    ],

    2:[ // PM during DI (middle column)
      {word:"unlucky",   sentence:"Unlucky. It was an unlucky day for me as I got caught in the heavy rain. Unlucky."},
      {word:"incorrect", sentence:"Incorrect. Your pronunciation of the word is incorrect. Incorrect."}
    ],

    3:[ // PM during DI (right column)
      {word:"unhappy", sentence:"Unhappy. John was unhappy as he lost his book. Unhappy."},
      {word:"insane",  sentence:"Insane. You must be insane if you think you can fly. Insane."}
    ]
  },
  /* =========================
     Cycle 17
     ========================= */

  C17S1:{
    /* -ing / -ful */

    1:[ // PM (left)
      {word:"singing",   sentence:"Singing. The choir is singing for our school festival. Singing."},
      {word:"stressful", sentence:"Stressful. It is stressful to perform in front of the entire school. Stressful."}
    ],

    2:[ // DI (middle)
      {word:"feeling",   sentence:"Feeling. He did not go to school as he was feeling unwell. Feeling."},
      {word:"powerful",  sentence:"Powerful. The King is a very powerful man. Powerful."}
    ],

    3:[ // DI (right)
      {word:"drawing",  sentence:"Drawing. The girl is drawing a picture of her pet dog. Drawing."},
      {word:"thankful", sentence:"Thankful. I am thankful to my parents for taking care of me. Thankful."}
    ]
  },

  C17S2:{
    /* re- / dis- */

    1:[ // PM (left)
      {word:"reread",    sentence:"Reread. She had to reread the whole text to understand what it was saying. Reread."},
      {word:"disliked",  sentence:"Disliked. He has always disliked sitting behind taller people. Disliked."}
    ],

    2:[ // DI (middle)
      {word:"reuse",     sentence:"Reuse. We can reuse our bottles to help save the environment. Reuse."},
      {word:"disbelief", sentence:"Disbelief. She was in disbelief when she heard that she scored full marks. Disbelief."}
    ],

    3:[ // DI (right)
      {word:"rethink", sentence:"Rethink. You need to rethink this matter before making your decision. Rethink."},
      {word:"disobey", sentence:"Disobey. We must not disobey the safety regulations at the theme park. Disobey."}
    ]
  },
  C17S3:{
    /* -er / -est */

    1:[ // PM (left column)
      {word:"darker",  sentence:"Darker. The sky became darker in the evening. Darker."},
      {word:"smallest",sentence:"Smallest. What is the smallest animal in the world? Smallest."}
    ],

    2:[ // PM during DI (middle column)
      {word:"greater", sentence:"Greater. The number ten has a greater value than the number five. Greater."},
      {word:"tallest", sentence:"Tallest. He is the tallest student in class. Tallest."}
    ],

    3:[ // PM during DI (right column)
      {word:"longer",  sentence:"Longer. Can you stay a little longer for the party? Longer."},
      {word:"cleanest",sentence:"Cleanest. I have the cleanest room in my family. Cleanest."}
    ]
  },
  /* =========================
     Cycle 18
     ========================= */

  C18S1:{
    /* mis- */

    1:[ // PM (left)
      {word:"misuse",  sentence:"Misuse. Do not misuse the class money and buy games for yourself. Misuse."},
      {word:"mislead", sentence:"Mislead. This information is incorrect and could mislead the public. Mislead."}
    ],

    2:[ // DI (middle)
      {word:"misplace", sentence:"Misplace. How could you misplace your bus card twice? Misplace."},
      {word:"miscount", sentence:"Miscount. Be careful not to miscount the money in our class fund. Miscount."}
    ],

    3:[ // DI (right)
      {word:"misbehave", sentence:"Misbehave. Do not misbehave when the teacher is not in class. Misbehave."},
      {word:"mistrust",  sentence:"Mistrust. I am filled with mistrust for him as he had lied to us. Mistrust."}
    ]
  },

  C18S2:{
    /* pre- */

    1:[ // PM (left)
      {word:"pretest", sentence:"Pretest. They have to do a pretest to see if they are ready for the actual test. Pretest."},
      {word:"premix",  sentence:"Premix. The store helped us to premix the spices for the curry. Premix."}
    ],

    2:[ // DI (middle)
      {word:"precook", sentence:"Precook. I usually precook my lunch and store it in the fridge the night before. Precook."},
      {word:"prepaid", sentence:"Prepaid. I loaded my prepaid card with some money. Prepaid."}
    ],

    3:[ // DI (right)
      {word:"preheat",  sentence:"Preheat. Preheat the oven before placing the food inside it. Preheat."},
      {word:"preview",  sentence:"Preview. The actors were invited to a sneak preview of the movie. Preview."}
    ]
  },
  C18S3:{
    1:[ // PM (left)
      {word:"restless", sentence:"Restless. He was feeling restless at home, so he decided to go for a walk. Restless."},
      {word:"harmless", sentence:"Harmless. My cat is harmless and will not scratch you. Harmless."}
    ],
    2:[ // PM during DI (middle)
      {word:"endless",  sentence:"Endless. The supply of water in Singapore is not endless, so we must save water. Endless."},
      {word:"hopeless", sentence:"Hopeless. She started to feel hopeless about finding her lost ring. Hopeless."}
    ],
    3:[ // PM during DI (right)
      {word:"helpless", sentence:"Helpless. The puppy was trapped and helpless until it was rescued from the drainpipe. Helpless."},
      {word:"homeless", sentence:"Homeless. There is a place for people who are homeless to sleep in. Homeless."}
    ]
  },








};

let SESSION_INFO = {};
let TRIES = {};

const PASSWORD = "0000";

/* ======================
   Teacher Records (NOT cleared by Always-Clear kit)
   ====================== */
const TEACHER_KEY = "PM_TEACHER_RECORDS::v1";

/* ======================
   DOM
   ====================== */
const studentName = document.getElementById("studentName");
const soundOn  = document.getElementById("soundOn");

const unlockAudioBtn = document.getElementById("unlockAudioBtn");
const unlock2Btn = document.getElementById("unlock2Btn");
const unlock3Btn = document.getElementById("unlock3Btn");

const resetBtn = document.getElementById("resetBtn");

const exportBtn = document.getElementById("exportBtn");
const importFile = document.getElementById("importFile");

const workBox  = document.getElementById("workBox");
const mastBox  = document.getElementById("mastBox");

const tryPill   = document.getElementById("tryPill");
const scorePill = document.getElementById("scorePill");

const date1El = document.getElementById("date-1");
const date2El = document.getElementById("date-2");
const date3El = document.getElementById("date-3");
const lockTag2 = document.getElementById("lockTag-2");
const lockTag3 = document.getElementById("lockTag-3");

const sessionSel = document.getElementById("sessionSel");
const sessionTag = document.getElementById("sessionTag");
const subText = document.getElementById("subText");
const modeHint = document.getElementById("modeHint");

/* Teacher modal DOM */
const teacherBtn = document.getElementById("teacherBtn");
const teacherModal = document.getElementById("teacherModal");
const closeTeacher = document.getElementById("closeTeacher");
const teacherSearch = document.getElementById("teacherSearch");
const recordsWrap = document.getElementById("recordsWrap");
const saveRecordBtn = document.getElementById("saveRecordBtn");
const exportRecordsBtn = document.getElementById("exportRecordsBtn");
const importRecordsFile = document.getElementById("importRecordsFile");
const clearRecordsBtn = document.getElementById("clearRecordsBtn");

/* ======================
   State
   ====================== */
let unlocked = false;
let currentTry = 1;

let tryUnlocked = {1:true, 2:false, 3:false};
let marked = {1:false, 2:false, 3:false};
let tryDate = {1:"", 2:"", 3:""};
let tryScore = {1:null, 2:null, 3:null};

/* store answers & mark html for export/import */
let stateAnswers = {1:["",""], 2:["",""], 3:["",""]};
let stateMarks   = {1:["",""], 2:["",""], 3:["",""]};

/* ======================
   Date helpers
   ====================== */
function todayYMD(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function setDateIfEmpty(t){
  if(!tryDate[t]){
    tryDate[t] = todayYMD();
    renderDates();
  }
}
function renderDates(){
  date1El.textContent = tryDate[1] || "";
  date2El.textContent = tryDate[2] || "";
  date3El.textContent = tryDate[3] || "";

  lockTag2.style.display = tryUnlocked[2] ? "none" : "inline-block";
  lockTag3.style.display = tryUnlocked[3] ? "none" : "inline-block";
}

/* ======================
   General helpers
   ====================== */
function ensureUnlocked(){
  if(unlocked) return;
  unlocked = true;
  unlockAudioBtn.textContent = "Audio Unlocked";
  unlockAudioBtn.disabled = true;
}

function findAffixInExpected(expRaw){
  const exp = cleanAnswer(expRaw);
  const targets = (SESSION_INFO.targets || []).slice()
    .sort((a,b)=>b.length-a.length); // prefer longer (e.g. "es" before "s")

  for(const tg of targets){
    if(!tg) continue;
    if(exp.startsWith(tg)) return {mode:"affix", pos:"prefix", tg};
    if(exp.endsWith(tg))   return {mode:"affix", pos:"suffix", tg};
  }
  return {mode:"full"};
}

function cleanAnswer(s){
  return (s||"").toLowerCase().replace(/[^a-z]/g,"");
}
function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  })[m]);
}
function masteryNeed(n){
  // 80% rule: 2/2, 5/6, 6/8, etc.
  return Math.max(1, Math.round(0.8*n));
}
function setStar(mastered){
  const wStar = workBox.querySelector(".star");
  const mStar = mastBox.querySelector(".star");

  if(mastered){
    workBox.classList.remove("starActive");
    mastBox.classList.add("starActive");
    if(wStar) wStar.textContent = "☆";
    if(mStar) mStar.textContent = "★";
  }else{
    mastBox.classList.remove("starActive");
    workBox.classList.add("starActive");
    if(wStar) wStar.textContent = "★";
    if(mStar) mStar.textContent = "☆";
  }
}
function setCurrentTry(t){
  currentTry = t;
  const name = (t===1 ? "1st try" : t===2 ? "2nd try" : "3rd try");
  tryPill.textContent = `Current: ${name}`;
}

/* ======================
   TTS (British-ish)
   ====================== */
function pickEnglishVoice(){
  if(!("speechSynthesis" in window)) return null;
  const voices = window.speechSynthesis.getVoices() || [];
  if(!voices.length) return null;

  const lower = (s)=>String(s||"").toLowerCase();

  const enGBExact = voices.find(v => lower(v.lang) === "en-gb");
  if(enGBExact) return enGBExact;

  const enGB = voices.find(v => lower(v.lang).startsWith("en-gb"));
  if(enGB) return enGB;

  const ukByName = voices.find(v => /uk|british/.test(lower(v.name)));
  if(ukByName) return ukByName;

  const en = voices.find(v => lower(v.lang).startsWith("en"));
  return en || voices[0] || null;
}

let cachedVoice = null;
function refreshVoice(){ cachedVoice = pickEnglishVoice(); }
if("speechSynthesis" in window){
  refreshVoice();
  window.speechSynthesis.onvoiceschanged = refreshVoice;
}

function speak(text){
  if(!soundOn.checked) return;
  if(!("speechSynthesis" in window)) return;
  if(!unlocked) return;

  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);

  if(!cachedVoice) refreshVoice();
  if(cachedVoice) u.voice = cachedVoice;

  u.rate = 0.82;
  u.pitch = 1.0;
  u.volume = 1.0;

  window.speechSynthesis.speak(u);
}

/* ======================
   Build booklet-like lines (always 2 blanks)
   ====================== */
function lineHtml(tryNo, idx){
  const id = `t${tryNo}-${idx}`;
  const disabled = !tryUnlocked[tryNo];
  return `
    <div>
      <div class="line" id="row-${id}">
        <div class="idx">${idx+1})</div>
        <div class="ansWrap">
          <input class="ans" id="in-${id}" ${disabled ? "disabled" : ""} autocomplete="off" spellcheck="false" inputmode="text">
        </div>
        <button class="hear" type="button" data-try="${tryNo}" data-idx="${idx}" ${disabled ? "disabled" : ""}>🔊</button>
      </div>
      <div class="mk" id="mk-${id}"></div>
    </div>
  `;
}

function rebuildAll(){
  for(const t of [1,2,3]){
    const area = document.getElementById(`area-${t}`);
    const list = Array.isArray(TRIES[t]) ? TRIES[t] : [];
    area.innerHTML = list.map((_,i)=>lineHtml(t,i)).join("");
  }

  // restore answers + marks
  for(const t of [1,2,3]){
    const list = Array.isArray(TRIES[t]) ? TRIES[t] : [];
    for(let i=0;i<list.length;i++){
      const el = document.getElementById(`in-t${t}-${i}`);
      const spk = document.querySelector(`button.hear[data-try="${t}"][data-idx="${i}"]`);
      const mk = document.getElementById(`mk-t${t}-${i}`);

      const disable = (!tryUnlocked[t]) || marked[t];
      if(el){
        el.value = (stateAnswers[t]?.[i] ?? "");
        el.disabled = disable;
      }
      if(spk) spk.disabled = disable;
      if(mk) mk.innerHTML = (stateMarks[t]?.[i] ?? "");
    }
  }
}

/* lowercase typing + set current try + date */
document.addEventListener("input", (e)=>{
  const el = e.target;
  if(el && el.classList && el.classList.contains("ans")){
    const pos = el.selectionStart;
    el.value = el.value.toLowerCase();
    try{ el.setSelectionRange(pos,pos); }catch(_){}
    const m = (el.id||"").match(/^in-t(\d+)-(\d+)$/);
    if(m){
      const t = +m[1];
      setCurrentTry(t);
      setDateIfEmpty(t);
    }
  }
});

/* Speak prompt when tap 🔊 */
function speakPrompt(tryNo, idx){
  if(!tryUnlocked[tryNo] || marked[tryNo]) return;
  const item = TRIES[tryNo][idx];
  ensureUnlocked();
  setCurrentTry(tryNo);
  setDateIfEmpty(tryNo);
  speak(`Spell this word. ${item.word}. ${item.sentence} The word again. ${item.word}.`);
}

document.addEventListener("click", (e)=>{
  const spk = e.target.closest(".hear");
  if(!spk) return;
  const t = +spk.dataset.try;
  const i = +spk.dataset.idx;
  const input = document.getElementById(`in-t${t}-${i}`);
  if(input && !input.disabled) input.focus();
  speakPrompt(t,i);
});

unlockAudioBtn.addEventListener("click", ()=>{
  ensureUnlocked();
  refreshVoice();
  speak("Audio unlocked.");
});

/* ======================
   Password unlock for try 2 / 3
   ====================== */
function askPassword(){
  const pw = prompt("Teacher password to unlock (0000):");
  return (pw === PASSWORD);
}

function unlockTry(t){
  if(tryUnlocked[t]) return true;
  if(!askPassword()){
    alert("Wrong password.");
    return false;
  }
  tryUnlocked[t] = true;
  setDateIfEmpty(t);
  renderDates();

  const list = Array.isArray(TRIES[t]) ? TRIES[t] : [];
  for(let i=0;i<list.length;i++){
    const el = document.getElementById(`in-t${t}-${i}`);
    const spk = document.querySelector(`button.hear[data-try="${t}"][data-idx="${i}"]`);
    if(el) el.disabled = false;
    if(spk) spk.disabled = false;
  }
  setCurrentTry(t);
  return true;
}
unlock2Btn.addEventListener("click", ()=>unlockTry(2));
unlock3Btn.addEventListener("click", ()=>unlockTry(3));

/* ======================
   Marking helpers
   ====================== */
function circledDiffHtml(answerRaw, expectedRaw){
  const ans = cleanAnswer(answerRaw);
  const exp = cleanAnswer(expectedRaw);

  if(!ans) return `<span class="miss">[ no response ]</span>`;

  const max = Math.max(ans.length, exp.length);
  let out = `<span class="circWord">`;
  for(let i=0;i<max;i++){
    const a = ans[i];
    const e = exp[i];
    if(a === undefined){
      out += `<span class="ch wrong">∅</span>`;
    }else if(e === undefined){
      out += `<span class="ch wrong">${escapeHtml(a)}</span>`;
    }else{
      const wrong = (a !== e);
      out += `<span class="ch ${wrong ? "wrong" : ""}">${escapeHtml(a)}</span>`;
    }
  }
  out += `</span>`;
  return out;
}

function captureAnswers(){
  for(const t of [1,2,3]){
    const arr = [];
    const list = Array.isArray(TRIES[t]) ? TRIES[t] : [];
    for(let i=0;i<list.length;i++){
      const el = document.getElementById(`in-t${t}-${i}`);
      arr.push(el ? el.value : "");
    }
    stateAnswers[t] = arr;
  }
}

/* ---- phonogram marking (your rule) ----
   If session has targets: word is correct as long as the target phonogram in the expected word
   is spelled correctly at ALL positions where it appears in the expected word.
*/
function findTargetsInExpected(exp){
  const expClean = cleanAnswer(exp);
  const targets = (SESSION_INFO.targets || []).slice();

  // special: magic-e patterns like a_e, i_e etc -> treat as whole-word check
  if(targets.some(t=>t.includes("_"))){
    return {mode:"magicE"};
  }

  // pick the first target that exists in expected
  for(const tg of targets){
    if(expClean.includes(tg)) return {mode:"phonogram", tg};
  }
  return {mode:"full"};
}
function allPositionsOf(s, sub){
  const pos = [];
  let i = 0;
  while(true){
    const j = s.indexOf(sub, i);
    if(j === -1) break;
    pos.push(j);
    i = j + 1;
  }
  return pos;
}
function countOccurrences(s, sub){
 if(!sub) return 0;
let c = 0, i = 0;
while(true){
const j = s.indexOf(sub, i);
    if(j === -1) break;
    c++;
    i = j + sub.length; // non-overlapping (e.g. "ss" in "dress")
  }
  return c;
}
function isCorrect(expected, raw){
  const exp = cleanAnswer(expected);
  const ans = cleanAnswer(raw);

  // ---- AFFIX marking (prefix/suffix) ----
  if(SESSION_INFO.markingMode === "affix"){
    const pick = findAffixInExpected(exp);
    if(pick.mode !== "affix") return ans === exp; // fallback
    const tg = pick.tg;
    if(pick.pos === "prefix"){
      // award if prefix is correct at the start
      return ans.startsWith(tg);
    }
    // suffix
    return ans.endsWith(tg);
  }

  // ---- PHONOGRAM marking (your existing rule) ----
    if(SESSION_INFO.markingMode === "phonogram"){
    const pick = findTargetsInExpected(exp);

    // magic-e stays whole-word (pattern-based)
    if(pick.mode === "magicE"){
      return ans === exp;
    }

    if(pick.mode === "phonogram"){
      const tg = pick.tg;

      // ✅ Target-only rule (SHIFT-TOLERANT):
      // Award mark if the response contains the target phonogram
      // at least as many times as the expected word contains it,
      // regardless of other letter errors.
      const need = countOccurrences(exp, tg) || 1;
      const got  = countOccurrences(ans, tg);
      return got >= need;
    }

    // fallback
    return ans === exp;
  }


  // ---- FULL word marking ----
  return ans === exp;
}

/* ======================
   Marking
   ====================== */
function markTry(t){
  if(!tryUnlocked[t]){
    alert("This try is locked. Teacher must unlock first.");
    return;
  }
  if(marked[t]) return;

  setDateIfEmpty(t);
  captureAnswers();

  const total = (Array.isArray(TRIES[t]) ? TRIES[t].length : 0);
  if(!total){
    alert("No words found for this try. (Data error)");
    return;
  }

  const need = masteryNeed(total);
  let correct = 0;

  for(let i=0;i<total;i++){
    const expected = TRIES[t][i].word;

    const input = document.getElementById(`in-t${t}-${i}`);
    const mk = document.getElementById(`mk-t${t}-${i}`);

    const raw = input ? input.value : "";
    const ok = isCorrect(expected, raw);
    if(ok) correct++;

   let hint = "";
    if(SESSION_INFO.markingMode === "phonogram"){
      const pick = findTargetsInExpected(expected);
      if(pick.mode === "phonogram"){
        hint = `<span style="font-size:13px; color:#475569;">(target: <b>${escapeHtml(pick.tg)}</b>)</span>`;
      }else if(pick.mode === "magicE"){
        hint = `<span style="font-size:13px; color:#475569;">(magic-e word)</span>`;
      }
    }else if(SESSION_INFO.markingMode === "affix"){
      const pick = findAffixInExpected(expected);
      if(pick.mode === "affix"){
        const label = (pick.pos === "prefix") ? "prefix" : "suffix";
        hint = `<span style="font-size:13px; color:#475569;">(target ${label}: <b>${escapeHtml(pick.tg)}</b>)</span>`;
      }
    }
    const html = `
      ${circledDiffHtml(raw, expected)}
      <span class="${ok ? "tick":"cross"}">${ok ? "✓" : "✗"}</span>
      ${hint}
      <div class="correctSp"><span class="label">Correct spelling:</span> ${escapeHtml(expected)}</div>
    `;
    if(mk) mk.innerHTML = html;
    stateMarks[t][i] = html;

    if(input) input.disabled = true;
    const spk = document.querySelector(`button.hear[data-try="${t}"][data-idx="${i}"]`);
    if(spk) spk.disabled = true;
  }

  const mastered = (correct >= need);
  marked[t] = true;
  tryScore[t] = {correct, total, need, mastered};

  scorePill.textContent = `Score: ${correct}/${total} (Need ${need})`;

  // visual cue: green ONLY if full score, else red
  scorePill.classList.remove("scoreBad","scoreOk");
  if(correct === total) scorePill.classList.add("scoreOk");
  else scorePill.classList.add("scoreBad");

  // show mastery immediately after marking (per try)
  setStar(mastered);

  if(unlocked && soundOn.checked){
    speak(mastered
      ? `Well done. You have mastered it. You got ${correct} out of ${total}.`
      : `Keep going. You got ${correct} out of ${total}.`);
  }
}

/* Column MARK buttons */
document.addEventListener("click", (e)=>{
  const b = e.target.closest("[data-marktry]");
  if(!b) return;
  const t = +b.dataset.marktry;
  ensureUnlocked();
  refreshVoice();
  setCurrentTry(t);
  markTry(t);
});

/* Clicking/focusing inside a try makes it current */
document.addEventListener("focusin", (e)=>{
  const el = e.target;
  if(!el || !el.classList || !el.classList.contains("ans")) return;
  const m = (el.id||"").match(/^in-t(\d+)-(\d+)$/);
  if(!m) return;
  const t = +m[1];
  setCurrentTry(t);
  setDateIfEmpty(t);
});

/* ======================
   JSON Export / Import (per pupil)
   ====================== */
function buildExportJson(){
  captureAnswers();
  const triesOut = {};
  for(const t of [1,2,3]){
    triesOut[t] = {
      unlocked: !!tryUnlocked[t],
      date: tryDate[t] || "",
      words: (TRIES[t]||[]).map(x=>x.word),
      sentences: (TRIES[t]||[]).map(x=>x.sentence),
      responses: (stateAnswers[t]||[]).slice(),
      marked: !!marked[t],
      score: tryScore[t] ? {...tryScore[t]} : null,
      markHtml: (stateMarks[t]||[]).slice()
    };
  }

  return {
    version: "pm-spelling-auto-mark-v4",
    exportedAt: new Date().toISOString(),
    sessionKey: sessionSel.value,
    sessionInfo: {...SESSION_INFO},
    studentName: (studentName.value || "").trim(),
    tries: triesOut
  };
}

function downloadJson(obj){
  const fnameBase = (obj.studentName ? obj.studentName.replace(/[^\w\-]+/g,"_") : "PM_Spelling");
  const fname = `${fnameBase}_${obj.sessionKey}_PM_${todayYMD()}.json`;

  const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = fname;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 250);
}

exportBtn.addEventListener("click", ()=>{
  const obj = buildExportJson();
  downloadJson(obj);
});

importFile.addEventListener("change", async (e)=>{
  const file = e.target.files && e.target.files[0];
  if(!file) return;

  try{
    const text = await file.text();
    const data = JSON.parse(text);

    if(!data || !data.version || !String(data.version).startsWith("pm-spelling-auto-mark")){
      alert("This JSON file is not a valid PM Spelling record.");
      importFile.value = "";
      return;
    }

    const key = String(data.sessionKey || "");
    if(key && SESSION_BANK[key] && TRIES_BANK[key]){
      applySession(key, true);
      sessionSel.value = key;
    }

    studentName.value = (data.studentName || "");

    for(const t of [1,2,3]){
      const td = data.tries && data.tries[t];
      if(!td) continue;

      tryUnlocked[t] = !!td.unlocked;
      tryDate[t] = td.date || "";

      const len = (TRIES[t]||[]).length;
      stateAnswers[t] = Array.isArray(td.responses) ? td.responses.slice(0, len) : new Array(len).fill("");
      stateMarks[t]   = Array.isArray(td.markHtml) ? td.markHtml.slice(0, len) : new Array(len).fill("");
      marked[t] = !!td.marked;
      tryScore[t] = td.score ? {...td.score} : null;
    }

    tryUnlocked[1] = true;

    renderDates();
    rebuildAll();

    setCurrentTry(1);
    scorePill.textContent = "Score: —";
    scorePill.classList.remove("scoreBad","scoreOk");
    setStar(false);

    let lastMarkedTry = 0;
    for(const t of [1,2,3]) if(marked[t]) lastMarkedTry = t;
    if(lastMarkedTry && tryScore[lastMarkedTry]){
      setCurrentTry(lastMarkedTry);
      const s = tryScore[lastMarkedTry];
      scorePill.textContent = `Score: ${s.correct}/${s.total} (Need ${s.need})`;

      scorePill.classList.remove("scoreBad","scoreOk");
      if(s.correct === s.total) scorePill.classList.add("scoreOk");
      else scorePill.classList.add("scoreBad");

      setStar(!!s.mastered);
    }

    alert("JSON loaded.");
  }catch(err){
    alert("Failed to load JSON. File may be corrupted.");
  }finally{
    importFile.value = "";
  }
});

/* ======================
   Reset
   ====================== */
function resetAll(){
  setStar(false);
  scorePill.textContent = "Score: —";
  scorePill.classList.remove("scoreBad","scoreOk");

  tryUnlocked = {1:true, 2:false, 3:false};
  marked = {1:false, 2:false, 3:false};
  tryScore = {1:null, 2:null, 3:null};

  tryDate = {1: todayYMD(), 2:"", 3:""};
  renderDates();

  const len1 = (TRIES[1]||[]).length, len2 = (TRIES[2]||[]).length, len3 = (TRIES[3]||[]).length;
  stateAnswers = {1:new Array(len1).fill(""), 2:new Array(len2).fill(""), 3:new Array(len3).fill("")};
  stateMarks   = {1:new Array(len1).fill(""), 2:new Array(len2).fill(""), 3:new Array(len3).fill("")};

  rebuildAll();
  setCurrentTry(1);

  const first = document.getElementById("in-t1-0");
  if(first) first.focus();
}
resetBtn.addEventListener("click", resetAll);

/* ======================
   Teacher Panel Logic
   ====================== */
function loadTeacherRecords(){
  try{
    const raw = localStorage.getItem(TEACHER_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  }catch(e){
    return [];
  }
}
function saveTeacherRecords(arr){
  localStorage.setItem(TEACHER_KEY, JSON.stringify(arr));
}
function tag(mastered){
  return mastered ? `<span class="tagOk">Mastered</span>` : `<span class="tagBad">Working</span>`;
}
function fmtTryScore(s){
  if(!s) return `<span class="tiny">—</span>`;
  const cls = (s.correct === s.total) ? "tagOk" : "tagBad";
  const label = `${s.correct}/${s.total}`;
  return `<span class="${cls}">${label}</span>`;
}
function renderTeacherTable(filterText=""){
  const q = String(filterText||"").trim().toLowerCase();
  const recs = loadTeacherRecords().slice().reverse();
  const rows = recs.filter(r=>{
    if(!q) return true;
    return String(r.studentName||"").toLowerCase().includes(q);
  });

  if(!rows.length){
    recordsWrap.innerHTML = `<div class="tiny">No records yet.</div>`;
    return;
  }

  let html = `
    <table>
      <thead>
        <tr>
          <th style="width:160px;">Pupil</th>
          <th style="width:110px;">Session</th>
          <th style="width:170px;">Dates</th>
          <th style="width:120px;">Try 1</th>
          <th style="width:120px;">Try 2</th>
          <th style="width:120px;">Try 3</th>
          <th style="width:140px;">Overall</th>
          <th style="width:130px;">Saved</th>
        </tr>
      </thead>
      <tbody>
  `;

  for(const r of rows){
    const d1 = r.tryDate?.[1] || "";
    const d2 = r.tryDate?.[2] || "";
    const d3 = r.tryDate?.[3] || "";
    const overallMastered = !!r.overallMastered;

    html += `
      <tr>
        <td>${escapeHtml(r.studentName||"")}</td>
        <td>${escapeHtml(r.sessionKey||"")}<div class="tiny">${escapeHtml(r.sessionTitle||"")}</div></td>
        <td class="tiny">1: ${escapeHtml(d1)}<br>2: ${escapeHtml(d2)}<br>3: ${escapeHtml(d3)}</td>
        <td>${fmtTryScore(r.tryScore?.[1])}</td>
        <td>${fmtTryScore(r.tryScore?.[2])}</td>
        <td>${fmtTryScore(r.tryScore?.[3])}</td>
        <td>${tag(overallMastered)}</td>
        <td class="tiny">${escapeHtml(new Date(r.savedAt||Date.now()).toLocaleString())}</td>
      </tr>
    `;
  }

  html += `</tbody></table>`;
  recordsWrap.innerHTML = html;
}

function openTeacherPanel(){
  if(!askPassword()) return;
  teacherModal.classList.add("show");
  teacherModal.setAttribute("aria-hidden","false");
  teacherSearch.value = "";
  renderTeacherTable("");
}
function closeTeacherPanel(){
  teacherModal.classList.remove("show");
  teacherModal.setAttribute("aria-hidden","true");
}

teacherBtn.addEventListener("click", openTeacherPanel);
closeTeacher.addEventListener("click", closeTeacherPanel);
teacherModal.addEventListener("click", (e)=>{
  if(e.target === teacherModal) closeTeacherPanel();
});
teacherSearch.addEventListener("input", ()=>renderTeacherTable(teacherSearch.value));

function computeOverallMastery(){
  const s1 = tryScore[1]?.mastered;
  const s2 = tryScore[2]?.mastered;
  const s3 = tryScore[3]?.mastered;
  return !!(s1 || s2 || s3);
}

saveRecordBtn.addEventListener("click", ()=>{
  const name = (studentName.value||"").trim();
  if(!name){
    alert("Please key in pupil name first.");
    return;
  }

  const recs = loadTeacherRecords();
  recs.push({
    version: "pm-teacher-record-v1",
    studentName: name,
    sessionKey: sessionSel.value,
    sessionTitle: SESSION_INFO.title,
    markingMode: SESSION_INFO.markingMode,
    tryDate: {...tryDate},
    tryScore: {
      1: tryScore[1] ? {...tryScore[1]} : null,
      2: tryScore[2] ? {...tryScore[2]} : null,
      3: tryScore[3] ? {...tryScore[3]} : null
    },
    overallMastered: computeOverallMastery(),
    savedAt: Date.now()
  });
  saveTeacherRecords(recs);
  renderTeacherTable(teacherSearch.value);
  alert("Saved to Teacher Records.");
});

exportRecordsBtn.addEventListener("click", ()=>{
  const recs = loadTeacherRecords();
  const obj = {
    version: "pm-teacher-records-export-v1",
    exportedAt: new Date().toISOString(),
    records: recs
  };
  const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `PM_Teacher_Records_${todayYMD()}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 250);
});

importRecordsFile.addEventListener("change", async (e)=>{
  const file = e.target.files && e.target.files[0];
  if(!file) return;

  try{
    const text = await file.text();
    const data = JSON.parse(text);
    if(!data || data.version !== "pm-teacher-records-export-v1" || !Array.isArray(data.records)){
      alert("Not a valid Teacher Records JSON.");
      importRecordsFile.value = "";
      return;
    }
    saveTeacherRecords(data.records);
    renderTeacherTable(teacherSearch.value);
    alert("Teacher records imported.");
  }catch(err){
    alert("Failed to import. File may be corrupted.");
  }finally{
    importRecordsFile.value = "";
  }
});

clearRecordsBtn.addEventListener("click", ()=>{
  if(!confirm("Clear ALL teacher records on this browser? This cannot be undone.")) return;
  saveTeacherRecords([]);
  renderTeacherTable(teacherSearch.value);
});

/* ======================
   Session switching
   ====================== */
function renderSessionHeader(){
  const key = sessionSel.value;
  sessionTag.textContent = key;
  subText.innerHTML = `<b>${escapeHtml(key)}:</b> ${escapeHtml(SESSION_INFO.title.replace(/^C\d+S\d+\s—\s?/, ""))}. Mastery is <b>about 80%</b>.`;
  modeHint.textContent = SESSION_INFO.hint || "";
}

function applySession(key, silent){
  const info = SESSION_BANK[key];
  const pack = TRIES_BANK[key];
  if(!info || !pack) return;

  SESSION_INFO = {...info};
  TRIES = JSON.parse(JSON.stringify(pack));

  // reset pupil UI/state (keep teacher records)
  setStar(false);
  scorePill.textContent = "Score: —";
  scorePill.classList.remove("scoreBad","scoreOk");

  tryUnlocked = {1:true, 2:false, 3:false};
  marked = {1:false, 2:false, 3:false};
  tryScore = {1:null, 2:null, 3:null};

  tryDate = {1: todayYMD(), 2:"", 3:""};
  renderDates();

  const len1 = (TRIES[1]||[]).length, len2 = (TRIES[2]||[]).length, len3 = (TRIES[3]||[]).length;
  stateAnswers = {1:new Array(len1).fill(""), 2:new Array(len2).fill(""), 3:new Array(len3).fill("")};
  stateMarks   = {1:new Array(len1).fill(""), 2:new Array(len2).fill(""), 3:new Array(len3).fill("")};

  renderSessionHeader();
  rebuildAll();
  setCurrentTry(1);

  if(!silent){
    const first = document.getElementById("in-t1-0");
    if(first) first.focus();
  }
}

sessionSel.addEventListener("change", ()=>{
  const key = sessionSel.value;
  if(marked[1] || marked[2] || marked[3] || (cleanAnswer(studentName.value).length>0)){
    const ok = confirm("Switching session will clear the current pupil’s work on-screen. Continue?");
    if(!ok){
      sessionSel.value = Object.keys(SESSION_BANK).includes(sessionTag.textContent) ? sessionTag.textContent : "C1S1";
      return;
    }
  }
  applySession(key);
});

/* ======================
   Init
   ====================== */
(function initSessions(){
  const keys = Object.keys(SESSION_BANK);
  // sort by cycle then session
  keys.sort((a,b)=>{
    const pa = a.match(/^C(\d+)S(\d+)$/), pb = b.match(/^C(\d+)S(\d+)$/);
    const ca = +(pa?.[1]||0), sa = +(pa?.[2]||0);
    const cb = +(pb?.[1]||0), sb = +(pb?.[2]||0);
    if(ca !== cb) return ca - cb;
    return sa - sb;
  });

  sessionSel.innerHTML = keys.map(k=>{
    const t = SESSION_BANK[k].title.replace(/^C\d+S\d+\s—\s?/, "");
    return `<option value="${k}">Cycle ${k.match(/^C(\d+)/)[1]} Session ${k.match(/^C\d+S(\d+)/)[1]} — ${escapeHtml(t)}</option>`;
  }).join("");

  sessionSel.value = "C1S1";
  applySession("C1S1", true);
})();
</script>
</body>
</html>
